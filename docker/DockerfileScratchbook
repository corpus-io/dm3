FROM --platform=linux/amd64 node:22-alpine as build
WORKDIR /app

# copy the whole repository to the container
COPY . .

# install bash for the following commands
RUN apk add --update bash\
    && rm -rf /var/cache/apk/*

RUN yarn install

# build libraries
WORKDIR /app/packages/lib
RUN yarn build

# pack libraries into archives
RUN for lib in `ls`; do cd $lib; yarn pack --filename ../$lib.tgz; cd ..;  done

# build delivery service
WORKDIR /app/packages/delivery-service
RUN yarn build
# pack delivery service into archive
RUN yarn pack --filename delivery-service.tgz

# start over with a new image
FROM node:22-alpine
WORKDIR /app

# copy and extract the delivery service archive
COPY --from=build /app/packages/delivery-service/delivery-service.tgz /app
RUN tar -xvzf delivery-service.tgz
RUN rm delivery-service.tgz
RUN mv package/* .
#RUN rmdir package

# copy and add the libraries archives. 
# We could omit some, but it's easier to just add all of them
RUN mkdir libs
COPY --from=build /app/packages/lib/*.tgz libs
# quickfix because server-side is not published yet
RUN yarn cache clean
RUN yarn add file:libs/server-side.tgz
RUN for lib in `ls libs`; do yarn add file:libs/$lib; done

# install dependencies
RUN yarn

# # build libraries
# WORKDIR /app/packages/lib
# RUN yarn build

# # pack libraries into archives
# RUN for lib in `ls`; do cd $lib; yarn pack --filename ../$lib.tgz; cd ..;  done

# # build delivery service
# WORKDIR /app/packages/delivery-service
# RUN yarn build
# # pack delivery service into archive
# RUN yarn pack --filename delivery-service.tgz

# # start over with a new image
# FROM node:22-alpine
# WORKDIR /app

# # copy and extract the delivery service archive
# COPY --from=build /app/packages/delivery-service/delivery-service.tgz /app
# RUN tar -xvzf delivery-service.tgz
# RUN rm delivery-service.tgz
# RUN mv package/* .
# #RUN rmdir package

# # copy and add the libraries archives. 
# # We could omit some, but it's easier to just add all of them
# RUN mkdir libs
# COPY --from=build /app/packages/lib/*.tgz libs
# # quickfix because server-side is not published yet
# RUN yarn cache clean
# RUN yarn add file:libs/server-side.tgz
# RUN for lib in `ls libs`; do yarn add file:libs/$lib; done

# RUN tar -xvzf delivery-service.tgz
# RUN rm delivery-service.tgz
# RUN mv package/* .
# RUN grep -v '@dm3-org/dm3-lib-server-side' package.json > package.json

# # install dependencies
# RUN yarn

# # done. start the package with `yarn start` in /app

# TODO: add ENTRYPOINT ["executable", "param1", "param2"] to start the service

# done. start the package with `yarn start` in /app

